USE telco;

-- 1) Вставка в customers
INSERT INTO customers (customer_id, gender, senior_citizen, partner, dependents, tenure)
SELECT
  customerID,
  gender,
  CAST(SeniorCitizen AS SIGNED),
  CASE WHEN Partner = 'Yes' THEN 1 ELSE 0 END,
  CASE WHEN Dependents = 'Yes' THEN 1 ELSE 0 END,
  COALESCE(tenure, 0)
FROM telco_staging
ON DUPLICATE KEY UPDATE
  gender = VALUES(gender),
  senior_citizen = VALUES(senior_citizen),
  partner = VALUES(partner),
  dependents = VALUES(dependents),
  tenure = VALUES(tenure);

-- 2) Словарь контрактов (contracts)
INSERT IGNORE INTO contracts (contract_type)
SELECT DISTINCT Contract
FROM telco_staging
WHERE Contract IS NOT NULL AND TRIM(Contract) <> '';

-- 3) Заполнение billing (приведение TotalCharges -> DECIMAL, пустые -> NULL)
INSERT INTO billing (customer_id, monthly_charges, total_charges, paperless_billing, payment_method)
SELECT
  customerID,
  MonthlyCharges,
  CASE WHEN TRIM(TotalCharges) = '' THEN NULL ELSE CAST(TRIM(TotalCharges) AS DECIMAL(12,2)) END,
  CASE WHEN PaperlessBilling = 'Yes' THEN 1 ELSE 0 END,
  PaymentMethod
FROM telco_staging
ON DUPLICATE KEY UPDATE
  monthly_charges = VALUES(monthly_charges),
  total_charges = VALUES(total_charges),
  paperless_billing = VALUES(paperless_billing),
  payment_method = VALUES(payment_method);

-- 4) Наполнение services (список всех сервисов из CSV)
INSERT IGNORE INTO services (service_name) VALUES
('PhoneService'),
('MultipleLines'),
('InternetService'),
('OnlineSecurity'),
('OnlineBackup'),
('DeviceProtection'),
('TechSupport'),
('StreamingTV'),
('StreamingMovies');

-- 5) Unpivot (staging columns -> строки) и вставка в customer_services
DROP TEMPORARY TABLE IF EXISTS tmp_service_rows;
CREATE TEMPORARY TABLE tmp_service_rows (
  customer_id VARCHAR(50),
  service_name VARCHAR(100),
  service_value VARCHAR(80)
) ENGINE=MEMORY;

INSERT INTO tmp_service_rows (customer_id, service_name, service_value)
SELECT customerID, 'PhoneService', PhoneService FROM telco_staging
UNION ALL
SELECT customerID, 'MultipleLines', MultipleLines FROM telco_staging
UNION ALL
SELECT customerID, 'InternetService', InternetService FROM telco_staging
UNION ALL
SELECT customerID, 'OnlineSecurity', OnlineSecurity FROM telco_staging
UNION ALL
SELECT customerID, 'OnlineBackup', OnlineBackup FROM telco_staging
UNION ALL
SELECT customerID, 'DeviceProtection', DeviceProtection FROM telco_staging
UNION ALL
SELECT customerID, 'TechSupport', TechSupport FROM telco_staging
UNION ALL
SELECT customerID, 'StreamingTV', StreamingTV FROM telco_staging
UNION ALL
SELECT customerID, 'StreamingMovies', StreamingMovies FROM telco_staging;

-- Удалим старые дубли для данного набора (опционально), затем вставим новые записи
-- Рекомендуется поддерживать уникальность через индекс (customer_id, service_id) — если нет, можно оставить
INSERT INTO customer_services (customer_id, service_id, service_value)
SELECT t.customer_id, s.service_id, t.service_value
FROM tmp_service_rows t
JOIN services s ON s.service_name = t.service_name
-- можно добавить WHERE t.service_value IS NOT NULL чтобы исключить пустые значения
;

DROP TEMPORARY TABLE IF EXISTS tmp_service_rows;

-- 6) Проверки (выведи результат в Workbench)
SELECT
  (SELECT COUNT(*) FROM telco_staging) AS staging_rows,
  (SELECT COUNT(*) FROM customers) AS customers_rows,
  (SELECT COUNT(*) FROM billing) AS billing_rows,
  (SELECT COUNT(*) FROM services) AS services_rows,
  (SELECT COUNT(*) FROM customer_services) AS customer_services_rows;

-- 7) Быстрая проверка валидности TotalCharges (нечисловые значения)
SELECT customerID, TotalCharges
FROM telco_staging
WHERE TRIM(TotalCharges) = '' OR TotalCharges NOT REGEXP '^[0-9]+(\\.[0-9]+)?$'
LIMIT 50;